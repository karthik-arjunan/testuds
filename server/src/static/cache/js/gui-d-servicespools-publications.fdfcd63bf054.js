// Generated by CoffeeScript 1.12.7
(function() {
  gui.servicesPools.publications = function(servPool, info) {
    var changelog, clApi, clTable, pubApi, publications, publicationsTable;
    pubApi = api.servicesPools.detail(servPool.id, "publications", {
      permission: servPool.permission
    });
    publications = new GuiElement(pubApi, "publications");
    publicationsTable = publications.table({
      doNotLoadData: true,
      icon: 'publications',
      container: "publications-placeholder_tbl",
      doNotLoadData: true,
      rowSelect: "single",
      buttons: [
        "new", {
          text: gettext("Cancel"),
          css: "disabled",
          disabled: true,
          click: function(val, value, btn, tbl, refreshFnc) {
            gui.doLog(val, val[0]);
            gui.forms.confirmModal(gettext("Publish"), gettext("Cancel publication?"), {
              onYes: function() {
                pubApi.invoke(val[0].id + "/cancel", function() {
                  refreshFnc();
                });
              }
            });
          },
          select: function(vals, self, btn, tbl, refreshFnc) {
            var val;
            if (vals.length !== 1) {
              $(btn).addClass("disabled");
              $(btn).prop('disabled', true);
              return;
            }
            val = vals[0];
            if (val.state === 'K') {
              $(btn).empty().append(gettext("Force Cancel"));
            } else {
              $(btn).empty().append(gettext("Cancel"));
            }
            gui.doLog("State: ", val.state);
            if (["P", "W", "L", "K"].indexOf(val.state) !== -1) {
              $(btn).removeClass("disabled").prop('disabled', false);
            } else {
              $(btn).addClass("disabled").prop('disabled', true);
            }
          }
        }, "xls"
      ],
      onNew: function(action, tbl, refreshFnc) {
        api.templates.get("publish", function(tmpl) {
          var content, modalId;
          content = api.templates.evaluate(tmpl);
          modalId = gui.launchModal(gettext("Publish"), content, {
            actionButton: "<button type=\"button\" class=\"btn btn-success button-accept\">" + gettext("Publish") + "</button>"
          });
          gui.tools.applyCustoms(modalId);
          $(modalId + " .button-accept").click(function() {
            var chlog;
            chlog = encodeURIComponent($('#id_publish_log').val());
            $(modalId).modal("hide");
            return pubApi.invoke("publish", (function() {
              refreshFnc();
              changelog.refresh();
            }), gui.failRequestModalFnc(gettext("Failed creating publication")), {
              params: 'changelog=' + chlog
            });
          });
        });
      }
    });
    clApi = api.servicesPools.detail(servPool.id, "changelog");
    changelog = new GuiElement(clApi, "changelog", {
      permission: servPool.permission
    });
    clTable = changelog.table({
      icon: 'publications',
      doNotLoadData: true,
      container: "changelog-placeholder",
      rowSelect: "single"
    });
    return [publicationsTable, clTable];
  };

}).call(this);
